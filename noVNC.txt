Baik, kasus yang kamu alami **sangat umum** di Raspberry Pi + VNC/noVNC, dan **bukan karena password kamu tiba-tiba salah**, melainkan karena **perbedaan konteks user dan service saat boot**.

Saya jelaskan **akar masalahnya dulu**, lalu **langkah perbaikan yang tepat dan stabil**.

---

## Ringkasannya dulu (biar jelas)

**Masalah utama:**

> Setelah reboot, noVNC/websockify jalan **sebelum** VNC server siap **atau** VNC server berjalan **di user/session yang berbeda**, sehingga **VNC menolak autentikasi**.

Makanya muncul error:

> `New connection has been rejected: username not recognised or password incorrect`

Padahal:

* Sebelum reboot → bisa
* Setelah reboot → gagal

---

## Penyebab paling sering (90% kasus)

### 1. **VNC Server tidak aktif saat boot (atau aktif tapi beda user)**

* VNC **manual jalan** saat kamu login
* Tapi **systemd noVNC jalan lebih dulu**
* Akhirnya noVNC connect ke VNC yang **belum siap / tidak ada**

### 2. **VNC password tersimpan per-user**

Raspberry Pi VNC (RealVNC / tightvnc) **password itu user-specific**, misalnya:

* `pi`
* `root`
* user lain

Jika:

* VNC server jalan sebagai `pi`
* websockify/noVNC jalan sebagai `root`
  → authentication **PASTI DITOLAK**

---

## Cara cek cepat (WAJIB)

Di Raspberry Pi, jalankan:

```bash
ps aux | grep vnc
ps aux | grep websockify
```

Perhatikan:

* VNC jalan sebagai user siapa?
* websockify/noVNC jalan sebagai user siapa?

Kalau **beda user**, itu sumber masalahnya.

---

## Solusi PALING STABIL (direkomendasikan)

### ✅ Gunakan **VNC server system-wide + noVNC systemd**

Bukan VNC manual per-session.

---

## LANGKAH 1 — Pastikan VNC aktif secara resmi

```bash
sudo raspi-config
```

Masuk ke:

```
Interface Options
→ VNC
→ Enable
```

Lalu reboot:

```bash
sudo reboot
```

---

## LANGKAH 2 — Set password VNC untuk user `pi`

Login via SSH, lalu:

```bash
vncpasswd
```

⚠️ **Jalankan sebagai user `pi`, BUKAN sudo**

Kalau pakai RealVNC:

```bash
realvnc-vnc-server
```

---

## LANGKAH 3 — Pastikan VNC benar-benar jalan setelah boot

Setelah reboot:

```bash
systemctl status vncserver-x11-serviced
```

Harus **active (running)**.

Jika belum:

```bash
sudo systemctl enable vncserver-x11-serviced
sudo systemctl start vncserver-x11-serviced
```

---

## LANGKAH 4 — Perbaiki service noVNC (INI BAGIAN KRITIS)

Edit service noVNC:

```bash
sudo nano /etc/systemd/system/novnc.service
```

Gunakan **format yang BENAR** ini:

```ini
[Unit]
Description=noVNC
After=network.target graphical.target vncserver-x11-serviced.service
Requires=vncserver-x11-serviced.service

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/noVNC
ExecStart=/usr/bin/websockify \
  --web=/home/pi/noVNC \
  6080 localhost:5900
Restart=always

[Install]
WantedBy=graphical.target
```

⚠️ **PENTING:**

* `User=pi` → HARUS sama dengan user VNC
* `After=vncserver-x11-serviced.service` → tunggu VNC siap
* `graphical.target` → pastikan desktop aktif

---

## LANGKAH 5 — Reload & enable ulang

```bash
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable novnc
sudo systemctl restart novnc
```

Cek:

```bash
systemctl status novnc
```

---

## LANGKAH 6 — TEST FINAL

1. Reboot:

```bash
sudo reboot
```

2. Tunggu ±1 menit
3. Buka browser:

```
http://IP_RASPBERRY:6080
```

4. Login pakai:

* **Username:** kosong / abaikan
* **Password:** hasil `vncpasswd`

---

## Kalau MASIH gagal (plan B)

Cek log real-time:

```bash
journalctl -u novnc -f
```

Atau:

```bash
journalctl -u vncserver-x11-serviced -f
```

Biasanya akan kelihatan:

* VNC belum ready
* Salah port
* Salah user

---

## Kesimpulan Teknis (buat laporan / logbook juga bisa)

> Masalah autentikasi noVNC setelah reboot disebabkan oleh perbedaan konteks eksekusi antara VNC server dan service websockify, di mana noVNC dijalankan sebelum VNC server siap atau menggunakan user yang berbeda. Solusi dilakukan dengan menyelaraskan user eksekusi, dependency service, dan target boot grafis menggunakan systemd.

Kalau kamu mau, aku bisa:

* Validasi **service file kamu satu per satu**
* Buatkan **versi paling minimal & clean**
* Atau sesuaikan dengan **Raspberry Pi 3 headless / tanpa monitor**

Tinggal bilang.




# Panduan Instalasi dan Menjalankan Aplikasi di Raspberry Pi

Dokumen ini berisi langkah-langkah lengkap untuk menginstal MySQL (MariaDB) dan menjalankan aplikasi **V2go-ecbtest** di Raspberry Pi dari nol.

---

## 1. Persiapan Sistem
Pertama, pastikan sistem Raspberry Pi Anda dalam keadaan terbaru.

```bash
sudo apt update
sudo apt upgrade -y
```

---

## 2. Instalasi dan Konfigurasi Database (MariaDB)
Raspberry Pi umumnya menggunakan MariaDB sebagai alternatif MySQL yang lebih ringan dan kompatibel.

### A. Instal MariaDB Server
```bash
sudo apt install mariadb-server -y
```

### B. Amankan Instalasi
Jalankan perintah ini untuk mengatur password root dan menghapus akses yang tidak perlu:
```bash
sudo mysql_secure_installation
```
*Ikuti petunjuk di layar (pilih 'Y' untuk semua saran, dan atur password root).*

### C. Buat Database dan User Aplikasi
Masuk ke terminal MySQL:
```bash
sudo mysql -u root -p
```

Di dalam shell MySQL/MariaDB, jalankan perintah berikut (sesuaikan dengan `.env` Anda):
```sql
-- Buat database
CREATE DATABASE ecbtest;

-- Buat user dan berikan akses (Gunakan password yang kuat)
-- Catatan: Menggunakan mysql_native_password agar kompatibel dengan library Go
CREATE USER 'ecb_user'@'localhost' IDENTIFIED VIA mysql_native_password USING PASSWORD 'password_anda_disini';

-- Berikan hak akses penuh ke database ecbtest
GRANT ALL PRIVILEGES ON ecbtest.* TO 'ecb_user'@'localhost';

-- Refresh hak akses
FLUSH PRIVILEGES;

-- Keluar
EXIT;
```

---

## 3. Persiapan Lingkungan Jalankan (Environment Setup)

### A. Instal Dependency Fyne (GUI Linux)
Aplikasi ini menggunakan Fyne untuk UI, sehingga butuh library grafis:
```bash
sudo apt install libgl1-mesa-dev xorg-dev libx11-dev libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev libxxf86vm-dev -y
```

### B. Instal Go (Golang)
Jika belum ada Go di Raspberry Pi:
```bash
# Cek arsitektur RPi (biasanya armv7l untuk RPi 3/4 32-bit atau aarch64 untuk 64-bit)
uname -m

# Contoh download Go 1.21.x (Sesuaikan dengan arsitektur Anda)
# Untuk ARMv7 (32-bit):
wget https://go.dev/dl/go1.21.6.linux-armv6l.tar.gz
sudo tar -C /usr/local -xzf go1.21.6.linux-armv6l.tar.gz

# Tambahkan ke Path
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc
```

---

## 4. Menyiapkan Aplikasi

### A. Clone atau Copy Project
Copy folder project `V2go-ecbtest` ke Raspberry Pi.

### B. Konfigurasi .env
Copy file `.env.example` menjadi `.env` dan sesuaikan nilainya:
```bash
cp .env.example .env
nano .env
```
Pastikan bagian database sesuai:
```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=ecb_user
DB_PASSWORD=password_anda_disini
DB_DATABASE=ecbtest

# Untuk Raspberry Pi, set mode LIVE jika sudah terhubung ke GPIO
ECB_MODE=LIVE
```

### C. Jalankan Migrasi Database
Untuk membuat tabel-tabel yang diperlukan:
```bash
# Pastikan berada di root folder project
go run cmd/migrate/main.go up
```

---

## 5. Build dan Menjalankan Aplikasi

### A. Kompilasi (Build)
Untuk hasil terbaik di Raspberry Pi, gunakan target build yang sudah dioptimasi di Makefile:
```bash
make build-rpi-optimized
```
Hasil build akan berada di `bin/ecom-rpi`.

### B. Menjalankan Aplikasi
```bash
# Berikan izin eksekusi
chmod +x bin/ecom-rpi

# Jalankan aplikasi
./bin/ecom-rpi
```

---

## 6. Akses Localhost dan Auto-Start (Kiosk Mode)

Jika ingin aplikasi langsung terbuka otomatis saat Raspberry Pi menyala (seperti mesin ATM):

### A. Buat Launcher Script
Buat file `/home/pi/start_ecb.sh`:
```bash
#!/bin/bash
sleep 5
cd /home/pi/projects/new-goecbtest
export FYNE_RENDER=software
./bin/ecom-rpi
```
Jangan lupa berikan izin: `chmod +x /home/pi/start_ecb.sh`

### B. Konfigurasi Autostart
Buat file `~/.config/autostart/ecb_kiosk.desktop`:
```ini
[Desktop Entry]
Type=Application
Name=ECB Test Kiosk
Exec=/home/pi/start_ecb.sh
Terminal=false
```

### C. Matikan Screen Sleep
Gunakan `sudo raspi-config` -> **Display Options** -> **Screen Blanking** -> **No**.
Pastikan juga **Desktop Autologin** aktif di menu **System Options**.

---

## Troubleshooting Tips
- **Gagal Connect DB**: Cek status database dengan `sudo systemctl status mariadb`.
- **Error Auth Plugin**: Jika muncul error `plugin 'mysql_native_password' is not loaded`, pastikan saat CREATE USER menggunakan `IDENTIFIED VIA mysql_native_password`.
- **X11: The DISPLAY environment variable is missing**:
  Aplikasi ini membutuhkan GUI. Jika Anda menjalankan via SSH, gunakan perintah:
  ```bash
  export DISPLAY=:0
  ./bin/ecom-rpi
  ```
  Atau jalankan langsung melalui terminal di dalam desktop Raspberry Pi (bukan remote SSH).
- **Layar Putih/Blank**: Pastikan driver GPU Raspberry Pi aktif (cek `raspi-config` -> Advanced -> GL Driver).
